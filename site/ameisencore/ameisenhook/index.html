<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>AmeisenHook - AmeisenBot Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "AmeisenHook";
    var mkdocs_page_input_path = "ameisencore\\AmeisenHook.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c#.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/nasm.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lua.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> AmeisenBot Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">AmeisenBot</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">AmeisenBot.Core</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../AmeisenCore/">AmeisenCore</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">AmeisenHook</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#ameisenhook">AmeisenHook</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#preperation">Preperation</a></li>
        
            <li><a class="toctree-l4" href="#assembly-instructions">Assembly instructions</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../AmeisenEventHook/">AmeisenEventHook</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">AmeisenBot Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>AmeisenBot.Core &raquo;</li>
        
      
    
    <li>AmeisenHook</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ameisenhook">AmeisenHook</h1>
<p>This is the class that manages the hookig of WoW's D3D9 Endscene function. We will hook it to execute functions on WoW's main thread. This funtion is called after every frame, so if we're at a framerate of 60 we have 60 executions per second which is enough for what it is beeing used for at the moment.</p>
<hr />
<h2 id="preperation">Preperation</h2>
<h3 id="getting-the-endscene-address">Getting the endscene address</h3>
<p>First we need to know where to apply our memory-modification (where the endscene is located).</p>
<p>Example code with 3.3.5a offsets:</p>
<pre><code class="C#">public readonly uint devicePtr1 = 0xC5DF88;
public readonly uint devicePtr2 = 0x397C;
public readonly uint endScene = 0xA8;

uint pDevice = BlackMagic.ReadUInt(Offsets.devicePtr1);
uint pEnd = BlackMagic.ReadUInt(pDevice + Offsets.devicePtr2);
uint pScene = BlackMagic.ReadUInt(pEnd);
uint endscene = BlackMagic.ReadUInt(pScene + Offsets.endScene);
</code></pre>

<hr />
<h3 id="using-the-found-offset">Using the found offset</h3>
<p>Now that we know where our functions is located we need to search for the first thing with a size of 5 bytes. Why 5 bytes, thats because we're going to place a JMP instruction at this place and as we know a JMP plus Address to jump to are 1 + 4 bytes on a 32Bit system.</p>
<p>So lets do it, our memory at the endscene address should look like this:</p>
<p><em>to be added...</em></p>
<p>As you might see there is something that's 5 bytes big, but it's offsetted by 0x2. That's no problem for us, we will just add that on top of our endscene</p>
<pre><code class="C#">public const uint ENDSCENE_OFFSET = 0x2;

uint endscene += ENDSCENE_OFFSET;
</code></pre>

<p>So far so good, we know where to apply our hook but how do we do it, what are we going to do?</p>
<ul>
<li>Jump from endscene function to our own instructions</li>
<li>Check if there is anything to execute</li>
<li>If there is something, execute it otherwise do nothing</li>
<li>After that return to the original like nothing happened</li>
</ul>
<hr />
<h3 id="codecaves">Codecaves</h3>
<p>Enough thinking, lets get down to business. First we need a place to store our Instrctions in the memory of WoW. </p>
<pre><code class="C#">uint codeCave = BlackMagic.AllocateMemory(64);
uint codeCaveForInjection = BlackMagic.AllocateMemory(256);
</code></pre>

<p><strong>codeCave</strong>: will be the place where we check if there are instructions to run.</p>
<p><strong>codeCaveForInjection</strong>: will be the place where we place our instructions that we want to execute</p>
<p><br></p>
<p>So far so good but how will we know that the code was executed? And what about return values? Don't worry its simple, just reserve two integers in WoW's memory.</p>
<pre><code class="C#">uint codeToExecute = BlackMagic.AllocateMemory(4);                        
uint returnAdress = BlackMagic.AllocateMemory(4);

BlackMagic.WriteInt(codeToExecute, 0);
BlackMagic.WriteInt(returnAdress, 0);
</code></pre>

<p><strong>codeToExecute</strong>: will hold 1 or 0 whether there is or isn't anything to execute</p>
<p><strong>returnAdress</strong>: will be a pointer to the data returned by the function we called</p>
<p>We're finished with our preperational stuff.</p>
<hr />
<h2 id="assembly-instructions">Assembly instructions</h2>
<h3 id="check-for-instructions-to-execute">Check for instructions to execute</h3>
<p>By now we've got everything prepared for our hook, so let's crawl through some Assembly.</p>
<p>Step one, the code that checks for instructions to be executed, we don't want to change anything that WoW can continue to work after we've done our stuff. Thats a problem because we will change something, there's no way of not doing that. So what wre we going to do about that? <em>PUSHFD</em>, <em>POPFD</em>, <em>PUSHAD</em> &amp; <em>POPAD</em>, that are the instructions we need.</p>
<p><strong>Simplified explanation</strong>:</p>
<p><em>PUSHFD</em> &amp; <em>PUSHAD</em> will save our registers</p>
<p><em>POPFD</em> &amp; <em>POPAD</em> will restore our registers</p>
<pre><code class="nasm">PUSHFD
PUSHAD

// our instructions will end up here

POPAD
POPFD
</code></pre>

<p><br></p>
<p>Now we're able to start the implementation of the "check for instructions" part.</p>
<p><strong>There are 9 steps to do that i've broke down into 3x3:</strong></p>
<ol>
<li>Load the value of codeToExecute into EBX</li>
<li>Compare EBX (the value of codeToExecute) to 1</li>
<li>If there is no code jump to @out (we will declare it later)</li>
</ol>
<p><strong>{(codeToExecute)}</strong>: replace that with you <em>codeToExecute</em> variable</p>
<pre><code class="nasm">MOV EBX, [{(codeToExecute)}]
TEST EBX, 1
JE @out
</code></pre>

<p><br></p>
<ol>
<li>Load the instructions position into EDX</li>
<li>Execute our custom instructions</li>
<li>Set the value of our <em>returnAdress</em> to the value of EAX
    -&gt; at this point EAX contains our return-value pointer and we want to save that for later</li>
</ol>
<p><strong>{(codeCaveForInjection)}</strong>: replace that with you <em>codeCaveForInjection</em> variable</p>
<p><strong>{(returnAdress)}</strong>: replace that with you <em>returnAdress</em> variable</p>
<pre><code class="nasm">MOV EDX, {(codeCaveForInjection)}
CALL EDX
MOV [{(returnAdress)}], EAX
</code></pre>

<p><br></p>
<ol>
<li>Declare our @out anker that we will jump to if there is nothing to execute</li>
<li>Set EDX to 0</li>
<li>set the value of <em>codeToExecute</em> to EDX (0) to signal that we are done</li>
</ol>
<p><strong>{(codeToExecute)}</strong>: replace that with you <em>codeToExecute</em> variable</p>
<pre><code class="nasm">@out:
MOV EDX, 0
MOV [{(codeToExecute)}], EDX
</code></pre>

<p><br></p>
<p>Your finished code should now look something like this:</p>
<pre><code class="nasm">PUSHFD
PUSHAD

MOV EBX, [{(codeToExecute)}]
TEST EBX, 1
JE @out
MOV EDX, {(codeCaveForInjection)}
CALL EDX
MOV [{(returnAdress)}], EAX
@out:
MOV EDX, 0
MOV [{(codeToExecute)}], EDX

POPAD
POPFD
</code></pre>

<p><br></p>
<p>These Instructions will be placed in the first <em>codeCave</em> that we've allocated, you can inject it using Blackmagic like this:</p>
<pre><code class="C#">BlackMagic.Asm.Clear();

foreach (string s in asm)
{
    BlackMagic.Asm.AddLine(s);
}

int asmLenght = BlackMagic.Asm.Assemble().Length;
BlackMagic.Asm.Inject(codeCave);
</code></pre>

<p><br></p>
<p>If you've done all of this there're only two things left to be done:</p>
<ol>
<li>Execute the original endscene stuff</li>
<li>Return to the original function</li>
</ol>
<pre><code class="C#">BlackMagic.WriteBytes(codeCave + (uint)asmLenght, originalEndscene);

BlackMagic.Asm.Clear();
BlackMagic.Asm.AddLine($&quot;JMP {(endsceneReturnAddress)}&quot;);
BlackMagic.Asm.Inject((codeCave + (uint)asmLenght) + 5);
</code></pre>

<p><br></p>
<p>First we are going to place the original EndScene instructions below our injected ones. You should  be able to read the original bytes like this:</p>
<pre><code class="C#">byte[] originalEndscene = BlackMagic.ReadBytes(endscene, 5);
</code></pre>

<p>or use mine (they might not work for you, first method is safer)</p>
<pre><code class="C#">byte[] originalEndscene = new byte[] { 0xB8, 0x51, 0xD7, 0xCA, 0x64 };
</code></pre>

<p><br></p>
<p>After this we want to return to the place where we came from:</p>
<pre><code class="nasm">JMP {(endsceneReturnAddress)}
</code></pre>

<pre><code class="C#">uint endsceneReturnAddress = endscene + 5;
</code></pre>

<p>Now we will return after the instruction that we will replace in a moment to finally hook WoW's EndScene. </p>
<p><br></p>
<p>Let's replace the original instructions with the one that jumps to our codeCave.</p>
<pre><code class="nasm">JMP {(codeCave)}
</code></pre>

<pre><code class="C#">BlackMagic.Asm.Clear();
BlackMagic.Asm.AddLine($&quot;JMP {(codeCave)}&quot;);
BlackMagic.Asm.Inject(endscene);
</code></pre>

<p>Congratulations, you hooked WoW's EndScene and it doesn't do anything. But don't worry the hardest part is done, we just need to inject the code we wan't to execute to the <em>codeCaveForInjection</em> and set <em>codeToExecute</em> to 1.</p>
<hr />
<h3 id="executing-your-stuff">Executing your stuff</h3>
<p>To execute your stuff just inject it to the <em>codeCaveForInjection</em> and set <em>codeToExecute</em> to 1. Remember that you should not inject new code while there is code beeing executed.</p>
<pre><code class="C#">while (BlackMagic.ReadInt(codeToExecute) &gt; 0)
{
    Thread.Sleep(1);
}

BlackMagic.Asm.Clear();
foreach (string s in asm)
{
    BlackMagic.Asm.AddLine(s);
}

BlackMagic.Asm.Inject(codeCaveForInjection);
BlackMagic.WriteInt(codeToExecute, 1);
</code></pre>

<p><br></p>
<p>After you've done that you could for example wait for the stuff-execution to finish and then read the returnAddress for a result.</p>
<pre><code class="C#">while (BlackMagic.ReadInt(codeToExecute) &gt; 0)
{
    Thread.Sleep(1);
}
</code></pre>

<hr />
<h3 id="reading-the-returnaddress">Reading the returnAddress</h3>
<p>Reading the returnAddress content is pretty easy.</p>
<pre><code class="C#">List&lt;byte&gt; returnBytes = new List&lt;byte&gt;();
byte buffer = new byte();

try
{
    uint dwAddress = BlackMagic.ReadUInt(returnAdress);
    buffer = BlackMagic.ReadByte(dwAddress);

    while (buffer != 0)
    {
        returnBytes.Add(buffer);
        dwAddress = dwAddress + 1;
        buffer = BlackMagic.ReadByte(dwAddress);
    }
}
catch (Exception e)
{
    AmeisenLogger.Instance.Log(
        LogLevel.ERROR,
        $&quot;Crash at reading returnAddress: {e.ToString()}&quot;,
        this
    );
}
</code></pre>

<p><em>to be continued...</em></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../AmeisenEventHook/" class="btn btn-neutral float-right" title="AmeisenEventHook">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../AmeisenCore/" class="btn btn-neutral" title="AmeisenCore"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../AmeisenCore/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../AmeisenEventHook/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
